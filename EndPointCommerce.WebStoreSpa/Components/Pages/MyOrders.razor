@page "/my-orders"

@using System.ComponentModel.DataAnnotations
@using EndPointCommerce.WebStoreSpa.Api
@using EndPointCommerce.WebStoreSpa.Identity
@using EndPointCommerce.WebStoreSpa.State

@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthenticationState
@inject IApiClient ApiClient
@inject AlertStateContainer AlertState

<PageTitle>My Orders - End Point Commerce</PageTitle>

<section class="py-5">
    <div class="container px-4 px-lg-5 my-5">
        <h1 class="mb-4">Your orders</h1>
        @foreach (var order in Orders)
        {
            <div class="card mb-2">
                <div class="card-header">
                    <div class="row">
                        <div class="col-md">
                            <div>Order placed on: @AsLongDate(order.DateCreated)</div>
                            <div>Status: @order.Status</div>
                        </div>
                        <div class="col-md">
                            <div>Order #: @order.Id</div>
                            <div>Tracking #: @(order.TrackingNumber ?? "N/A")</div>
                        </div>
                        <div class="col-md">
                            <div>Total: @AsCurrency(order.Total)</div>
                            <div><a href="/my-orders/@order.Guid">View details</a></div>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    @foreach (var item in order.Items)
                    {
                        <div class="card mb-2 p-3">
                            <div class="row g-0">
                                <div class="col-md-4 text-center">
                                    @if (!string.IsNullOrEmpty(item.Product.ThumbnailImageUrl))
                                    {
                                        <img
                                            class="img-fluid rounded small-thumbnail"
                                            src="@item.Product.ThumbnailImageUrl"
                                            alt="@item.Product.Name"
                                        />
                                    }
                                    else
                                    {
                                        <img
                                            class="img-fluid rounded small-thumbnail"
                                            src="https://dummyimage.com/300x300/dee2e6/6c757d.jpg"
                                            alt="@item.Product.Name"
                                        />
                                    }
                                </div>
                                <div class="col-md-8">
                                    <p class="fs-4">@item.Quantity x @item.Product.Name</p>
                                    <p>SKU: @item.Product.Sku</p>
                                    <p>@AsCurrency(item.Total)</p>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>
        }
    </div>
</section>

@code {
    private List<Order> Orders = new();

    protected override async Task OnInitializedAsync()
    {
        Orders = await ApiClient.GetOrders();
    }

    protected string AsLongDate(DateTime? value) =>
        value?.ToString("D", System.Globalization.CultureInfo.GetCultureInfo("en-US")) ?? string.Empty;

    protected string AsCurrency(decimal value) =>
        value.ToString("C", System.Globalization.CultureInfo.GetCultureInfo("en-US"));
}